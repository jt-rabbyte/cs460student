<html>

<head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
    <meta content="utf-8" http-equiv="encoding" />
    <title>Flashy Fish!</title>
    <style>
        html,
        body {
            background-color: #000;
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden !important;

            /* Part 10 - Background*/
            background: url('https://cs460.org/assignments/04/bg.jpg');
            background-size: cover; 
        }

        #c {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<script type="text/javascript" src="https://cs460.org/js/glmatrix.js"></script>

<script id="vertexshader" type="glsl">
    attribute vec3 a_position;

    uniform float u_pointsize; // Part 2 - eye of the fish
    uniform mat4 u_transform; // Part 6 - Enter the matrix

    void main(void) {
      vec4 final_position = u_transform * vec4( a_position, 1.); // Part 6
      gl_Position = final_position; // Part 6
      gl_PointSize = u_pointsize; // Part 2 - eye of the fish
    }
  </script>

<script id="fragmentshader" type="glsl">
    precision mediump float;

    uniform vec4 u_color;

    void main(void) {

      gl_FragColor = u_color;

    }
  </script>

<script>
    var c, gl;
    var v_shader, f_shader, shaderprogram;
    var vertices, indices, v_buffer, i_buffer;

    window.onload = function () {
        //************************************************************//
        //
        // INITIALIZE WEBGL
        //
        c = document.getElementById("c"); // setup canvas
        c.width = window.innerWidth;
        c.height = window.innerHeight;

        gl = c.getContext("webgl"); // setup GL context
        gl.viewport(0, 0, c.width, c.height);

        //************************************************************//
        //
        // SHADERS
        //
        v_shader = gl.createShader(gl.VERTEX_SHADER);
        f_shader = gl.createShader(gl.FRAGMENT_SHADER);

        // compile vertex shader
        gl.shaderSource(v_shader, document.getElementById("vertexshader").innerText);
        gl.compileShader(v_shader);

        if (!gl.getShaderParameter(v_shader, gl.COMPILE_STATUS)) {
            console.log(gl.getShaderInfoLog(v_shader));
        }

        // compile fragment shader
        gl.shaderSource(
            f_shader,
            document.getElementById("fragmentshader").innerText
        );
        gl.compileShader(f_shader);

        if (!gl.getShaderParameter(f_shader, gl.COMPILE_STATUS)) {
            console.log(gl.getShaderInfoLog(f_shader));
        }

        // attach and link the shaders
        shaderprogram = gl.createProgram();
        gl.attachShader(shaderprogram, v_shader);
        gl.attachShader(shaderprogram, f_shader);

        gl.linkProgram(shaderprogram);
        gl.useProgram(shaderprogram);

        // Part 1 - Change rectangles[] to all_fish[]
        all_fish = [];

        // Part 11 - Flip direction of first fish
        all_fish.push( createFish( [0, 0, 0], [1, 0, 0, 1], 1, -1) );

        // Part 4 - Add many fish
        for (let i = 0; i < 40; i++) {
            let random_color = [
                Math.random(), Math.random(), Math.random(), Math.random()
            ];
            
            let random_offset = [
                Math.random() - Math.random(), // random X offset
                Math.random() - Math.random(), // random Y offset
                0
            ];

            let random_scale = Math.random() * 0.3; // smaller fish

            all_fish.push(createFish(random_offset, random_color, random_scale, 1));
        }

        animate();
    };


    // Part 1 - Changed createRectangle to createFish
    function createFish(offset, color, scale, direction) {
        //************************************************************//
        //
        // CREATE GEOMETRY
        //
        vertices = new Float32Array([
                0.5,    0.0,    0.0, // 0: nose
                0.2,    0.25,   0.0, // 1: upper body
                -0.2,   0.15,   0.0, // 2: upper tail base
                -0.4,   0.3,    0.0, // 3: upper tail tip
                -0.4,   -0.3,   0.0, // 4: lower tail tip
                -0.2,   -0.15,  0.0, // 5: lower tail base
                0.2,    -0.25,  0.0, // 6: lower body
            ]);
        indices = new Uint8Array([
                0, 1, 6, // main body
                1, 2, 6, // upper mid-body
                2, 5, 6, // rear body
                2, 3, 5, // tail top
                3, 4, 5, // tail fin
            ]);

        var v_buffer = gl.createBuffer(); // create
        gl.bindBuffer(gl.ARRAY_BUFFER, v_buffer); // bind
        gl.bufferData(gl.ARRAY_BUFFER, vertices, gl.STATIC_DRAW); // put data in
        gl.bindBuffer(gl.ARRAY_BUFFER, null); // unbind

        var i_buffer = gl.createBuffer(); // create
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, i_buffer); // bind
        gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, indices, gl.STATIC_DRAW); // put data in
        gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, null); // unbind

        // Part 2 - Defining eye vertex
        eye_vertex = new Float32Array([0.2, 0.2, 0.0]);

        if (direction == -1) eye_vertex = new Float32Array([0.2, -0.2, 0.0]);

        eye_v_buffer = gl.createBuffer(); // create
        gl.bindBuffer(gl.ARRAY_BUFFER, eye_v_buffer); // bind
        gl.bufferData(gl.ARRAY_BUFFER, eye_vertex, gl.STATIC_DRAW); // put data in
        gl.bindBuffer(gl.ARRAY_BUFFER, null); // unbind

        return [v_buffer, i_buffer, eye_v_buffer, color, offset, scale, direction];
    }

    var step_x = 0.01;
    var step_y = 0.01;
    var direction = -1;

    function animate() {
        requestAnimationFrame(animate);

        gl.clearColor(0, 0, 0, 0);
        gl.clear(gl.COLOR_BUFFER_BIT);

        // Part 9 - Explicitly add transparency
        gl.enable(gl.BLEND);
        gl.blendEquation(gl.FUNC_ADD);
        gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);
        gl.disable(gl.DEPTH_TEST);

        // Part 1 - Change rectangles[] to all_fish[] in for loop
        for (var r = 0; r < all_fish.length; r++) {
            // current_buffers is a list of [v_buffer, i_buffer]-pairs
            var current_buffers = all_fish[r];
            var current_v_buffer = current_buffers[0];
            var current_i_buffer = current_buffers[1];
            var current_eye_v_buffer = current_buffers[2]; // Part 3 - Rendering the eye
            var current_color = current_buffers[3]; 
            var current_offset = current_buffers[4];
            var current_scale = current_buffers[5];
            var current_direction = current_buffers[6];

            // Part 5 - Move the fish
            // Move fish slightly every frame
            current_offset[0] += 0.01;                // move right
            current_offset[1] += 0.1 * Math.random(); // random up
            current_offset[1] -= 0.1 * Math.random(); // random down

            // Reverse direction if fish hits the right edge
            if (current_offset[0] >= 1) current_direction = -1;
            // Apply the direction
            current_offset[0] *= current_direction;

            //************************************************************//
            //
            // CONNECT SHADER WITH GEOMETRY
            //

            gl.bindBuffer(gl.ARRAY_BUFFER, current_v_buffer);
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, current_i_buffer);

            // find the attribute in the shader source
            var a_position = gl.getAttribLocation(shaderprogram, "a_position");
            gl.vertexAttribPointer(a_position, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(a_position);

            // find the uniform in the shader source

            // Part 6 - Build the transform matrix (column-major order)
            // Part 7 & 8 - Incorporate rotate and scale
            let theta = Math.random() * 10 * Math.PI / 180; // Random rotation between 0â€“10 degrees, converted to radians
            let transform = [
                current_direction*current_scale*Math.cos(theta),    Math.sin(theta),    0,  0,
                -Math.sin(theta),   current_direction*current_scale*Math.cos(theta),    0,  0,
                0,  0,  current_direction*current_scale*1,  0,
                current_offset[0],  current_offset[1],  current_direction*current_offset[2],    1
            ];

            // Get the uniform location (once, or per frame)
            var u_transform = gl.getUniformLocation(shaderprogram, 'u_transform');
            // Send matrix to the shader
            gl.uniformMatrix4fv(u_transform, false, new Float32Array(transform));

            var u_color = gl.getUniformLocation(shaderprogram, "u_color");

            // Part 12 - Apply blue tones on fish
            t = performance.now() * 0.001;
            a = 0.6 + 0.4 * Math.sin(t * 2.0);
            current_color = new Float32Array([
                0.3 + 0.2*Math.sin(t + 0.0),
                0.6 + 0.2*Math.sin(t + 2.0),
                0.9 + 0.1*Math.sin(t + 4.0),
                a
            ]);

            if (r == 0) {
                // the large fish aka. first object should still be red!
                current_color = [1, 0, 0, .7];
            }

            gl.uniform4fv(u_color, current_color);
            //************************************************************//
            //
            // DRAW!
            //

            // Part 1 - Modified to draw proper number of vertices
            gl.drawElements(gl.TRIANGLES, indices.length, gl.UNSIGNED_BYTE, 0);

            // Part 3 - Draw eye
            gl.uniform4fv(u_color, new Float32Array([0, 0, 0, 0.5]));
            
            var u_pointsize = gl.getUniformLocation(shaderprogram, "u_pointsize");
            gl.uniform1fv(u_pointsize, new Float32Array([current_scale * 20.]));

            gl.enableVertexAttribArray ( a_position );
            gl.bindBuffer( gl.ARRAY_BUFFER, current_eye_v_buffer ); // Part 11 - Modified to reverse eye
            gl.vertexAttribPointer(a_position, 3, gl.FLOAT, false, 0, 0);
            gl.enableVertexAttribArray(a_position);
            gl.drawArrays( gl.POINTS, 0, 1);
        }
    }
</script>

<body>
    <canvas id="c"></canvas>
</body>

</html>